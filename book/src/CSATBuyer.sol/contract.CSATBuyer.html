<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CSATBuyer</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../src/CSAEngineV2/index.html">❱ CSAEngineV2</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/CSAEngineV2/CSAEngineV2.sol/contract.CSAEngineV2.html">CSAEngineV2</a></li><li class="chapter-item "><a href="../../src/CSAEngineV2/CSAEngineV2StorageContract.sol/contract.CSAEngineV2StorageContract.html">CSAEngineV2StorageContract</a></li></ol></li><li class="chapter-item "><a href="../../src/CSAMarketplace/index.html">❱ CSAMarketplace</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/CSAMarketplace/CSAMarketplace.sol/contract.CSAMarketplace.html">CSAMarketplace</a></li><li class="chapter-item "><a href="../../src/CSAMarketplace/CSAMarketplaceStorageContract.sol/contract.CSAMarketplaceStorageContract.html">CSAMarketplaceStorageContract</a></li></ol></li><li class="chapter-item "><a href="../../src/CSASwap/index.html">❱ CSASwap</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/CSASwap/CSASwap.sol/contract.CSASwap.html">CSASwap</a></li><li class="chapter-item "><a href="../../src/CSASwap/CSASwapStorageContract.sol/contract.CSASwapStorageContract.html">CSASwapStorageContract</a></li></ol></li><li class="chapter-item "><a href="../../src/CSAT/index.html">❱ CSAT</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/CSAT/CSAT.sol/contract.CSAT.html">CSAT</a></li><li class="chapter-item "><a href="../../src/CSAT/CSATStorageContract.sol/contract.CSATStorageContract.html">CSATStorageContract</a></li></ol></li><li class="chapter-item "><a href="../../src/CSATTeam/index.html">❱ CSATTeam</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/CSATTeam/CSATTeam.sol/contract.CSATTeam.html">CSATTeam</a></li><li class="chapter-item "><a href="../../src/CSATTeam/CSATTeamStorageContract.sol/contract.CSATTeamStorageContract.html">CSATTeamStorageContract</a></li></ol></li><li class="chapter-item "><a href="../../src/CSAOracleV2.sol/contract.CSAOracleV2.html">CSAOracleV2</a></li><li class="chapter-item "><a href="../../src/CSAQueueLib.sol/library.CSAQueueLib.html">CSAQueueLib</a></li><li class="chapter-item expanded "><a href="../../src/CSATBuyer.sol/contract.CSATBuyer.html" class="active">CSATBuyer</a></li><li class="chapter-item "><a href="../../src/CSATeamOracle.sol/contract.CSATeamOracle.html">CSATeamOracle</a></li><li class="chapter-item "><a href="../../src/CSAVault.sol/contract.CSAVault.html">CSAVault</a></li><li class="chapter-item "><a href="../../src/IBurnableMintable.sol/interface.Mintable.html">Mintable</a></li><li class="chapter-item "><a href="../../src/IBurnableMintable.sol/interface.Burnable.html">Burnable</a></li><li class="chapter-item "><a href="../../src/TransferManager.sol/contract.TransferManager.html">TransferManager</a></li><li class="chapter-item "><a href="../../src/USDCMock.sol/contract.USDCMock.html">USDCMock</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="csatbuyer"><a class="header" href="#csatbuyer">CSATBuyer</a></h1>
<p><strong>Inherits:</strong>
Initializable, AccessControlUpgradeable, UUPSUpgradeable, ERC2771ContextUpgradeable, ReentrancyGuardUpgradeable</p>
<p><strong>Author:</strong>
Maurizio Murru https://github.com/akerbabber</p>
<p><em>This contract is a buyer for CSAT tokens. It is able to buy CSAT tokens from the marketplace and from the swap in
a single transaction. It is able to calculate the optimal amount to buy from the marketplace and from the swap.
It is able to calculate the maximum amount that can be bought from the marketplace.
It is able to calculate the fallback id in the marketplace for a given amount.
It supports meta transactions and is upgradeable (UUPS).</em></p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="max_n_orders"><a class="header" href="#max_n_orders">MAX_N_ORDERS</a></h3>
<p><em>Maximum number of orders to check in the CSAMarketplace, if the requested amount is greater than the sum of the first
MAX_N_ORDERS, the remaining amount will be bought from the fallback order with the highest amount.
If even the fallback is not enough, it will rely on the CSASwap.</em></p>
<pre><code class="language-solidity">uint256 constant MAX_N_ORDERS = 4;
</code></pre>
<h3 id="min_amount_in"><a class="header" href="#min_amount_in">MIN_AMOUNT_IN</a></h3>
<p><em>Minimum amount of USDC that can be sold for CSAT using CSATBuyer. This limit is in place to avoid
to make anti-economic making transactions with a very low amount of USDC. Otherwise the paymaster could
be drained to pay for the gas fees of the transaction.</em></p>
<pre><code class="language-solidity">uint256 constant MIN_AMOUNT_IN = 5e6;
</code></pre>
<h3 id="csaswap_address"><a class="header" href="#csaswap_address">CSASWAP_ADDRESS</a></h3>
<p><em>Address of the CSASwap contract.</em></p>
<pre><code class="language-solidity">address public immutable CSASWAP_ADDRESS;
</code></pre>
<h3 id="csamarketplace_address"><a class="header" href="#csamarketplace_address">CSAMARKETPLACE_ADDRESS</a></h3>
<p><em>Address of the CSAMarketplace contract.</em></p>
<pre><code class="language-solidity">address public immutable CSAMARKETPLACE_ADDRESS;
</code></pre>
<h3 id="usdc_address"><a class="header" href="#usdc_address">USDC_ADDRESS</a></h3>
<p><em>Address of the USDC token contract.</em></p>
<pre><code class="language-solidity">address public immutable USDC_ADDRESS;
</code></pre>
<h3 id="upgrader_role"><a class="header" href="#upgrader_role">UPGRADER_ROLE</a></h3>
<p><em>Role for the upgrader, he can upgrade the contract.</em></p>
<pre><code class="language-solidity">bytes32 public constant UPGRADER_ROLE = keccak256("UPGRADER_ROLE");
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>Constructor for the CSATBuyer contract.</p>
<p><em>All variables are immutable, as such their values are hardcoded into the contract code</em></p>
<p><em>Changing them requires an upgrade of the contract</em></p>
<pre><code class="language-solidity">constructor(address _usdcAddress, address _csaswapAddress, address _csamarketplaceAddress, address _trustedForwarder)
    ERC2771ContextUpgradeable(_trustedForwarder);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_usdcAddress</code></td><td><code>address</code></td><td>Address of the USDC token contract</td></tr>
<tr><td><code>_csaswapAddress</code></td><td><code>address</code></td><td>Address of the CSASwap contract</td></tr>
<tr><td><code>_csamarketplaceAddress</code></td><td><code>address</code></td><td>Address of the CSAMarketplace contract</td></tr>
<tr><td><code>_trustedForwarder</code></td><td><code>address</code></td><td>Address of the trusted forwarder</td></tr>
</tbody></table>
</div>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<p>Initializes the CSATBuyer contract.</p>
<pre><code class="language-solidity">function initialize() public initializer;
</code></pre>
<h3 id="_authorizeupgrade"><a class="header" href="#_authorizeupgrade">_authorizeUpgrade</a></h3>
<p><em>Reverts if called by any account other than an upgrader.</em></p>
<pre><code class="language-solidity">function _authorizeUpgrade(address newImplementation) internal override onlyRole(UPGRADER_ROLE);
</code></pre>
<h3 id="maximumbuyonmarketplace"><a class="header" href="#maximumbuyonmarketplace">maximumBuyOnMarketplace</a></h3>
<p>Returns the maximum amount that can be bought from the marketplace in a single transaction.</p>
<p><em>This function is expensive, do not call it onchain.</em></p>
<pre><code class="language-solidity">function maximumBuyOnMarketplace() public view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>The maximum amount that can be bought from the marketplace.</td></tr>
</tbody></table>
</div>
<h3 id="getfallbackidfrommarketplace"><a class="header" href="#getfallbackidfrommarketplace">getFallbackIdFromMarketplace</a></h3>
<p>Returns the fallback id in the marketplace for a given amount.</p>
<p><em>This function is expensive, do not call it onchain.</em></p>
<pre><code class="language-solidity">function getFallbackIdFromMarketplace(uint256 _amount) external view returns (uint48);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amount</code></td><td><code>uint256</code></td><td>The amount for which to get the fallback id.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint48</code></td><td>The fallback id in the marketplace for the given amount.</td></tr>
</tbody></table>
</div>
<h3 id="getoptimalinput"><a class="header" href="#getoptimalinput">getOptimalInput</a></h3>
<p>Returns the optimal input to pass to the buyCsatFor() function, for the given amount.</p>
<p><em>This function is expensive, do not call it onchain.</em></p>
<pre><code class="language-solidity">function getOptimalInput(uint256 _amount)
    external
    view
    returns (uint256 _amountMarketplace, uint256 _amountSwap, uint48 _fallbackId);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amount</code></td><td><code>uint256</code></td><td>The amount for which to get the optimal input.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amountMarketplace</code></td><td><code>uint256</code></td><td>The amount to buy from the marketplace.</td></tr>
<tr><td><code>_amountSwap</code></td><td><code>uint256</code></td><td>The amount to buy from the swap.</td></tr>
<tr><td><code>_fallbackId</code></td><td><code>uint48</code></td><td>The fallback id in the marketplace.</td></tr>
</tbody></table>
</div>
<h3 id="buycsatfor"><a class="header" href="#buycsatfor">buyCsatFor</a></h3>
<p>Buys CSAT tokens for the given amount.</p>
<pre><code class="language-solidity">function buyCsatFor(uint256 _amountMarketplace, uint256 _amountSwap, uint48 _fallbackId, address _receiver)
    external
    nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_amountMarketplace</code></td><td><code>uint256</code></td><td>The amount to buy from the marketplace.</td></tr>
<tr><td><code>_amountSwap</code></td><td><code>uint256</code></td><td>The amount to buy from the swap.</td></tr>
<tr><td><code>_fallbackId</code></td><td><code>uint48</code></td><td>The fallback id in the marketplace.</td></tr>
<tr><td><code>_receiver</code></td><td><code>address</code></td><td>The address that will receive the CSAT tokens.</td></tr>
</tbody></table>
</div>
<h3 id="_msgsender"><a class="header" href="#_msgsender">_msgSender</a></h3>
<pre><code class="language-solidity">function _msgSender() internal view override(ContextUpgradeable, ERC2771ContextUpgradeable) returns (address sender);
</code></pre>
<h3 id="_msgdata"><a class="header" href="#_msgdata">_msgData</a></h3>
<pre><code class="language-solidity">function _msgData() internal view override(ContextUpgradeable, ERC2771ContextUpgradeable) returns (bytes calldata);
</code></pre>
<h3 id="_contextsuffixlength"><a class="header" href="#_contextsuffixlength">_contextSuffixLength</a></h3>
<pre><code class="language-solidity">function _contextSuffixLength()
    internal
    view
    override(ContextUpgradeable, ERC2771ContextUpgradeable)
    returns (uint256);
</code></pre>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="boughtcsat"><a class="header" href="#boughtcsat">BoughtCSAT</a></h3>
<p><em>Event emitted when CSAT tokens are bought trough the CSATBuyer contract.</em></p>
<pre><code class="language-solidity">event BoughtCSAT(
    address indexed _buyer,
    uint256 _amountMarketplace,
    uint256 _fallbackId,
    uint256 _amountSwap,
    address indexed _receiver
);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_buyer</code></td><td><code>address</code></td><td>The address of the buyer.</td></tr>
<tr><td><code>_amountMarketplace</code></td><td><code>uint256</code></td><td>The amount bought from the marketplace.</td></tr>
<tr><td><code>_fallbackId</code></td><td><code>uint256</code></td><td>The fallback id in the marketplace.</td></tr>
<tr><td><code>_amountSwap</code></td><td><code>uint256</code></td><td>The amount bought from the swap.</td></tr>
<tr><td><code>_receiver</code></td><td><code>address</code></td><td>The address that will receive the CSAT tokens.</td></tr>
</tbody></table>
</div>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<h3 id="amounttoolow"><a class="header" href="#amounttoolow">AmountTooLow</a></h3>
<p><em>Error emitted when the amount of USDC is too low to use the contract.</em></p>
<pre><code class="language-solidity">error AmountTooLow(uint256 _amount);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/CSAQueueLib.sol/library.CSAQueueLib.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../src/CSATeamOracle.sol/contract.CSATeamOracle.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/CSAQueueLib.sol/library.CSAQueueLib.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../src/CSATeamOracle.sol/contract.CSATeamOracle.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../solidity.min.js"></script>


    </div>
    </body>
</html>
